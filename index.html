<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Interactiva de Distribución</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 450px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 450px;
        }
        @media (max-width: 1024px) {
            .chart-container {
                height: 35vh;
                max-height: 400px;
            }
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-900">Calculadora de Distribución</h1>
            <p class="mt-2 text-lg text-slate-600">Modifica los valores para ver cómo cambia la distribución en tiempo real.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <h2 class="text-2xl font-semibold mb-6 text-slate-800">Parámetros de Cálculo</h2>
                
                <div class="space-y-6">
                    <div>
                        <h3 class="font-medium text-slate-700 mb-3">Valores Iniciales de Reparto</h3>
                        <div id="initial-values-container" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                        </div>
                    </div>

                    <div>
                        <h3 class="font-medium text-slate-700 mb-3">Montos Totales a Distribuir</h3>
                        <div class="space-y-4">
                            <!-- Se han añadido los campos 'disabled' para que estos montos no sean editables por el usuario. -->
                            <div>
                                <label for="monto1" class="block text-sm font-medium text-slate-600">Primera compra (CLOOTS)</label>
                                <input type="number" id="monto1" value="309794.752128" disabled class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 bg-slate-100 cursor-not-allowed">
                            </div>
                            <div>
                                <label for="monto2" class="block text-sm font-medium text-slate-600">Segunda compra (CLOOTS)</label>
                                <input type="number" id="monto2" value="13604.167272" disabled class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 bg-slate-100 cursor-not-allowed">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-medium text-slate-700 mb-3">Conversión a Dólares</h3>
                        <div class="space-y-4">
                            <div>
                                <label for="conversion-method" class="block text-sm font-medium text-slate-600">Método de Conversión</label>
                                <select id="conversion-method" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                                    <option value="usd">Valor Fijo (USD)</option>
                                    <option value="market-cap">Market Cap</option>
                                </select>
                            </div>
                            <div id="usd-conversion-input-container">
                                <label for="cloots-to-usd" class="block text-sm font-medium text-slate-600">1 CLOOTS en USD</label>
                                <input type="number" id="cloots-to-usd" value="0.005" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                            <div id="market-cap-input-container" class="hidden">
                                <label for="market-cap" class="block text-sm font-medium text-slate-600">Market Cap deseado (M USD)</label>
                                <!-- Se ha eliminado el atributo step="any" -->
                                <input type="number" id="market-cap" value="10" class="mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2">
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                <h2 class="text-2xl font-semibold mb-4 text-slate-800 text-center">Resultados de la Distribución</h2>
                
                <div class="chart-container mb-6">
                    <canvas id="distributionChart"></canvas>
                </div>

                <div class="overflow-x-auto mb-8">
                    <table class="w-full text-sm text-left text-slate-600">
                        <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                            <tr>
                                <th scope="col" class="px-4 py-3">Persona</th>
                                <th scope="col" class="px-4 py-3 text-right">Porcentaje</th>
                                <th scope="col" class="px-4 py-3 text-right">Primera compra</th>
                                <th scope="col" class="px-4 py-3 text-right">Segunda compra</th>
                                <th scope="col" class="px-4 py-3 text-right font-bold">Total (CLOOTS)</th>
                                <th scope="col" class="px-4 py-3 text-right font-bold">Total (USD)</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                        </tbody>
                    </table>
                </div>

                <div class="mt-8 pt-4 border-t border-slate-200">
                    <h3 class="text-xl font-semibold mb-4 text-slate-800 text-center">Funcionalidades de Gemini</h3>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <button id="explain-button" class="flex-1 bg-blue-600 text-white font-medium py-3 px-4 rounded-md shadow-lg hover:bg-blue-700 transition-colors">Explicar Cálculo ✨</button>
                        <button id="draft-message-button" class="flex-1 bg-green-600 text-white font-medium py-3 px-4 rounded-md shadow-lg hover:bg-green-700 transition-colors">Redactar Mensaje ✨</button>
                    </div>
                    <div id="gemini-output" class="bg-slate-100 p-4 rounded-md text-slate-700 whitespace-pre-wrap min-h-[50px] flex items-center justify-center">
                        <div id="loading-indicator" class="hidden loading-spinner"></div>
                        <p id="output-text" class="text-center">Haz clic en un botón para generar texto.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const peopleData = [
                { name: 'Tu', value: 100 },
                { name: 'Sol', value: 50 },
                { name: 'Bri', value: 30 },
                { name: 'Pana', value: 30 },
                { name: 'Yo', value: 100 }
            ];

            const monto1Input = document.getElementById('monto1');
            const monto2Input = document.getElementById('monto2');
            const conversionMethodSelect = document.getElementById('conversion-method');
            const usdConversionInputContainer = document.getElementById('usd-conversion-input-container');
            const marketCapInputContainer = document.getElementById('market-cap-input-container');
            const clootsToUsdInput = document.getElementById('cloots-to-usd');
            const marketCapInput = document.getElementById('market-cap');

            const initialValuesContainer = document.getElementById('initial-values-container');
            const resultsTableBody = document.getElementById('results-table-body');
            const explainButton = document.getElementById('explain-button');
            const draftMessageButton = document.getElementById('draft-message-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const outputText = document.getElementById('output-text');
            
            let distributionChart;

            const formatCloots = (value) => {
                return 'CLOOTS ' + new Intl.NumberFormat('es-VE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
            };

            const formatDollars = (value) => {
                return 'USD ' + new Intl.NumberFormat('es-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(value);
            };

            const createInitialValueInputs = () => {
                peopleData.forEach((person, index) => {
                    const div = document.createElement('div');
                    const label = document.createElement('label');
                    label.htmlFor = `person-${index}`;
                    label.className = 'block text-sm font-medium text-slate-600';
                    label.textContent = person.name;

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `person-${index}`;
                    input.value = person.value;
                    input.className = 'mt-1 block w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-2 person-input';
                    input.dataset.index = index;
                    
                    div.appendChild(label);
                    div.appendChild(input);
                    initialValuesContainer.appendChild(div);
                });
            };

            const calculateAndRender = () => {
                const monto1 = parseFloat(monto1Input.value) || 0;
                const monto2 = parseFloat(monto2Input.value) || 0;
                
                let clootsToUsd;
                const conversionMethod = conversionMethodSelect.value;

                if (conversionMethod === 'usd') {
                    clootsToUsd = parseFloat(clootsToUsdInput.value) || 0;
                } else if (conversionMethod === 'market-cap') {
                    // Suministro total fijo asumido para el cálculo del Market Cap
                    // 1,000,000,000 tokens es necesario para que 10M de market cap = $0.01/token
                    const totalSupply = 1000000000;
                    // El campo de entrada ya usa parseFloat para manejar los decimales
                    const marketCapInUsd = parseFloat(marketCapInput.value) * 1000000 || 0;
                    clootsToUsd = totalSupply > 0 ? (marketCapInUsd / totalSupply) : 0;
                }

                const personInputs = document.querySelectorAll('.person-input');
                personInputs.forEach((input, index) => {
                    peopleData[index].value = parseFloat(input.value) || 0;
                });

                const totalInitialValue = peopleData.reduce((sum, person) => sum + person.value, 0);
                const percentages = peopleData.map(person => totalInitialValue > 0 ? (person.value / totalInitialValue) : 0);
                
                resultsTableBody.innerHTML = '';
                peopleData.forEach((person, index) => {
                    const percentage = percentages[index];
                    const fromMonto1 = monto1 * percentage;
                    const fromMonto2 = monto2 * percentage;
                    const totalPersonCloots = fromMonto1 + fromMonto2;
                    const totalPersonUsd = totalPersonCloots * clootsToUsd;

                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b border-slate-200';
                    row.innerHTML = `
                        <th scope="row" class="px-4 py-3 font-medium text-slate-900 whitespace-nowrap">${person.name}</th>
                        <td class="px-4 py-3 text-right">${(percentage * 100).toFixed(2)}%</td>
                        <td class="px-4 py-3 text-right">${formatCloots(fromMonto1)}</td>
                        <td class="px-4 py-3 text-right">${formatCloots(fromMonto2)}</td>
                        <td class="px-4 py-3 text-right font-bold text-slate-800">${formatCloots(totalPersonCloots)}</td>
                        <td class="px-4 py-3 text-right font-bold text-slate-800">${formatDollars(totalPersonUsd)}</td>
                    `;
                    resultsTableBody.appendChild(row);
                });

                updateChart(percentages);
            };

            const updateChart = (percentages) => {
                const chartData = {
                    labels: peopleData.map(p => p.name),
                    datasets: [{
                        label: 'Distribución de Porcentaje',
                        data: percentages,
                        backgroundColor: [
                            '#3b82f6', '#10b981', '#f97316', '#8b5cf6', '#ec4899',
                        ],
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 4
                    }]
                };

                if (distributionChart) {
                    distributionChart.data.labels = chartData.labels;
                    distributionChart.data.datasets[0].data = chartData.datasets[0].data;
                    distributionChart.update();
                } else {
                    const ctx = document.getElementById('distributionChart').getContext('2d');
                    distributionChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: chartData,
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: {
                                        padding: 20,
                                        boxWidth: 12,
                                        font: {
                                            size: 14
                                        }
                                    }
                                },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.label || '';
                                            if (label) {
                                                label += ': ';
                                            }
                                            if (context.parsed !== null) {
                                                label += (context.parsed * 100).toFixed(2) + '%';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            cutout: '60%'
                        }
                    });
                }
            };
            
            const callGeminiApi = async (prompt) => {
                loadingIndicator.classList.remove('hidden');
                outputText.textContent = '';
                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                // NOTA IMPORTANTE: Para publicar, necesitas obtener tu propia clave de API y reemplazar las comillas vacías.
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                let response;
                let retries = 0;
                const maxRetries = 5;
                const baseDelay = 1000;

                while (retries < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.status === 429) {
                            const delay = Math.pow(2, retries) * baseDelay + Math.random() * 1000;
                            retries++;
                            await new Promise(res => setTimeout(res, delay));
                            continue;
                        }

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const result = await response.json();
                        if (result.candidates && result.candidates.length > 0 &&
                            result.candidates[0].content && result.candidates[0].content.parts &&
                            result.candidates[0].content.parts.length > 0) {
                            const text = result.candidates[0].content.parts[0].text;
                            outputText.textContent = text;
                        } else {
                            outputText.textContent = "Error: No se pudo obtener una respuesta de la API.";
                        }
                        break;
                    } catch (error) {
                        outputText.textContent = `Error: ${error.message}`;
                        break;
                    }
                }
                loadingIndicator.classList.add('hidden');
            };

            const explainCalculation = () => {
                const totalInitialValue = peopleData.reduce((sum, person) => sum + person.value, 0);
                const percentages = peopleData.map(person => totalInitialValue > 0 ? (person.value / totalInitialValue) : 0);

                let explanationPrompt = `Proporciona una explicación simple y amigable en español sobre cómo se calcularon los porcentajes.
                Valores iniciales: ${peopleData.map(p => `${p.name}: ${p.value}`).join(', ')}.
                El valor total es ${totalInitialValue}.
                Los porcentajes son: ${peopleData.map((p, i) => `${p.name}: ${(percentages[i] * 100).toFixed(2)}%`).join(', ')}.
                Explica brevemente la fórmula usada.`;
                
                callGeminiApi(explanationPrompt);
            };

            const draftMessage = () => {
                const monto1 = parseFloat(monto1Input.value) || 0;
                const monto2 = parseFloat(monto2Input.value) || 0;
                const totalMonto = monto1 + monto2;
                
                let clootsToUsd;
                const conversionMethod = conversionMethodSelect.value;
                if (conversionMethod === 'usd') {
                    clootsToUsd = parseFloat(clootsToUsdInput.value) || 0;
                } else if (conversionMethod === 'market-cap') {
                    const totalSupply = 1000000000;
                    const marketCapInUsd = parseFloat(marketCapInput.value) * 1000000 || 0;
                    clootsToUsd = totalSupply > 0 ? (marketCapInUsd / totalSupply) : 0;
                }

                const totalMontoUsd = totalMonto * clootsToUsd;

                const personDataForPrompt = peopleData.map((person, index) => {
                    const percentage = peopleData.map(p => peopleData.reduce((sum, p) => sum + p.value, 0) > 0 ? (p.value / peopleData.reduce((sum, p) => sum + p.value, 0)) : 0)[index];
                    const fromMonto1 = monto1 * percentage;
                    const fromMonto2 = monto2 * percentage;
                    const totalPersonCloots = fromMonto1 + fromMonto2;
                    const totalPersonUsd = totalPersonCloots * clootsToUsd;
                    return `${person.name}: recibe ${formatCloots(totalPersonCloots)} (${formatDollars(totalPersonUsd)})`;
                }).join('\n');

                const draftPrompt = `Redacta un mensaje amable y claro en español para un grupo de personas. El mensaje debe comunicar la distribución de un total de ${formatCloots(totalMonto)} (equivalente a ${formatDollars(totalMontoUsd)}).
                Los montos individuales son:\n${personDataForPrompt}.
                El mensaje debe ser conciso y directo, explicando el propósito de la distribución.`;

                callGeminiApi(draftPrompt);
            };

            const toggleConversionInputs = () => {
                const conversionMethod = conversionMethodSelect.value;
                if (conversionMethod === 'usd') {
                    usdConversionInputContainer.classList.remove('hidden');
                    marketCapInputContainer.classList.add('hidden');
                } else {
                    usdConversionInputContainer.classList.add('hidden');
                    marketCapInputContainer.classList.remove('hidden');
                }
                calculateAndRender();
            };

            const addEventListeners = () => {
                document.querySelectorAll('.person-input, #cloots-to-usd, #market-cap').forEach(input => {
                    input.addEventListener('input', calculateAndRender);
                });
                conversionMethodSelect.addEventListener('change', toggleConversionInputs);
                explainButton.addEventListener('click', explainCalculation);
                draftMessageButton.addEventListener('click', draftMessage);
            };

            const init = () => {
                createInitialValueInputs();
                toggleConversionInputs(); // Establecer el estado inicial de los campos
                addEventListeners();
            };

            init();
        });
    </script>
</body>
</html>
